# 临时存储集成示例

## 概述

本文档展示如何在 `RPDCreateModalNew` 组件中集成临时存储功能，实现图片的临时上传、AI描述生成和智能清理。

## 1. 组件集成示例

```typescript
// RPDCreateModalNew.tsx 的更新版本

import React, { useCallback, useEffect, useState } from 'react';
import { useImageUpload } from '@/hooks/useImageUpload';
import { useRPDSession } from '@/hooks/useRPDSession';
import { assetsService } from '@/api/assetsService';
import type { GenerateImageDescriptionResponse } from '@/types/assets';

interface RPDCreateModalNewProps {
  isOpen: boolean;
  onClose: () => void;
  projectId: string;
}

export default function RPDCreateModalNew({ isOpen, onClose, projectId }: RPDCreateModalNewProps) {
  // ... 现有状态
  const [currentStep, setCurrentStep] = useState<1 | 2>(1);
  const [selectedKey, setSelectedKey] = useState<PredefinedRPDKey | null>(null);
  const [title, setTitle] = useState<string>('');
  const [detailContent, setDetailContent] = useState<string>('');
  const [tags, setTags] = useState<string[]>([]);
  const [showError, setShowError] = useState<string | null>(null);

  // 会话管理
  const {
    sessionId,
    cleanupSession,
    promoteTempImages,
    isSessionActive,
    refreshSession,
  } = useRPDSession({
    autoCleanup: true,
    sessionTimeout: 2 * 60 * 60 * 1000, // 2小时
  });

  // 图片上传管理
  const {
    uploadedFiles,
    uploadingCount,
    generatingCount,
    isProcessing,
    uploadFiles,
    regenerateDescription,
    removeFile,
    clearFiles,
    getFileDescription,
  } = useImageUpload({
    rpdType: selectedKey || 'general_ng_review',
    context: detailContent,
    autoGenerateDescription: true,
    maxConcurrentUploads: 2,
    sessionId, // 传递会话ID
    useTempStorage: true, // 启用临时存储
  });

  // 刷新会话活跃状态
  useEffect(() => {
    if (isOpen && isSessionActive) {
      refreshSession();
    }
  }, [isOpen, isSessionActive, refreshSession, detailContent]);

  // 处理图片上传
  const handleImageUpload = useCallback(async (files: FileList | null) => {
    if (!files || !isSessionActive) return;

    try {
      setShowError(null);
      await uploadFiles(files);
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : '图片上传失败';
      setShowError(errorMessage);
      console.error('Failed to upload images:', error);
    }
  }, [uploadFiles, isSessionActive]);

  // 重新生成描述
  const handleRegenerateDescription = useCallback(async (fileId: string) => {
    if (!isSessionActive) return;

    try {
      await regenerateDescription(fileId, detailContent);
    } catch (error) {
      console.error('Failed to regenerate description:', error);
      // 可以显示错误提示
    }
  }, [regenerateDescription, detailContent, isSessionActive]);

  // 获取图片描述（支持临时存储状态）
  const getImageDescription = useCallback((fileId: string): string => {
    const description = getFileDescription(fileId);
    if (description) {
      return description.detailed_description;
    }

    // 根据状态返回不同的提示
    const file = uploadedFiles.find(f => f.id === fileId);
    if (!file) return '文件未找到';

    switch (file.status) {
      case 'uploading':
        return '正在上传到临时存储...';
      case 'generating':
        return '正在生成AI描述...';
      case 'error':
        return file.error || '处理失败';
      default:
        return '等待处理...';
    }
  }, [getFileDescription, uploadedFiles]);

  // 处理模态框关闭
  const handleClose = useCallback(async () => {
    try {
      // 清理所有状态
      form.reset();
      setSelectedKey(null);
      setTitle('');
      setDetailContent('');
      setTags([]);
      setShowError(null);
      setCurrentStep(1);

      // 清理上传文件的blob URL
      clearFiles();

      // 清理临时会话文件
      await cleanupSession();

      onClose();
    } catch (error) {
      console.error('Failed to cleanup session on close:', error);
      // 即使清理失败也要关闭模态框
      onClose();
    }
  }, [form, clearFiles, cleanupSession, onClose]);

  // 处理RPD创建提交
  const handleSubmit = useCallback(async (data: FormData) => {
    if (!isSessionActive) {
      setShowError('会话已过期，请重新开始');
      return;
    }

    try {
      setShowError(null);

      // 准备RPD数据（包含临时图片URL）
      const rpdData = {
        ...data,
        projectId,
        title,
        tags,
        uploadedImages: uploadedFiles
          .filter(f => f.status === 'completed' && f.s3Url)
          .map(f => ({
            url: f.s3Url!,
            description: f.description?.detailed_description || '',
            keywords: f.description?.suggested_keywords || [],
          })),
        detailContent,
      };

      // 创建RPD
      console.log('Creating RPD with data:', rpdData);
      // await createRPD(rpdData); // 实际的RPD创建API调用

      // 成功创建后，将临时文件提升为正式文件
      try {
        await promoteTempImages(projectId);
        console.log('Successfully promoted temporary images to project');
      } catch (promotionError) {
        console.error('Failed to promote temporary images:', promotionError);
        // 这里可以选择是否要回滚RPD创建，或者只是记录错误
      }

      // 关闭模态框（不执行清理，因为文件已提升）
      form.reset();
      setSelectedKey(null);
      setTitle('');
      setDetailContent('');
      setTags([]);
      setCurrentStep(1);
      clearFiles();
      onClose();

    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'RPD创建失败';
      setShowError(errorMessage);
      console.error('Failed to create RPD:', error);
    }
  }, [
    isSessionActive,
    projectId,
    title,
    tags,
    uploadedFiles,
    detailContent,
    promoteTempImages,
    form,
    clearFiles,
    onClose,
  ]);

  // 组件卸载时确保清理
  useEffect(() => {
    return () => {
      if (!isOpen) {
        // 延迟清理，确保其他操作完成
        setTimeout(() => {
          cleanupSession();
        }, 1000);
      }
    };
  }, [isOpen, cleanupSession]);

  return (
    <Dialog open={isOpen} onOpenChange={(open) => !open && handleClose()}>
      <DialogContent className="sm:max-w-6xl max-h-[85vh] p-0 overflow-hidden border-0 shadow-2xl">
        {/* 会话状态指示器 */}
        {!isSessionActive && (
          <div className="bg-red-50 border-l-4 border-red-400 p-4 m-4">
            <div className="flex">
              <div className="flex-shrink-0">
                <svg className="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                </svg>
              </div>
              <div className="ml-3">
                <p className="text-sm text-red-700">
                  会话已过期。请刷新页面重新开始。
                </p>
              </div>
            </div>
          </div>
        )}

        {/* 处理状态指示器 */}
        {isProcessing && (
          <div className="bg-blue-50 border-l-4 border-blue-400 p-3 m-4">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
              </div>
              <div className="ml-3">
                <p className="text-sm text-blue-700">
                  {uploadingCount > 0 && `正在上传 ${uploadingCount} 个文件到临时存储...`}
                  {generatingCount > 0 && `正在生成 ${generatingCount} 个AI描述...`}
                </p>
              </div>
            </div>
          </div>
        )}

        {/* 错误提示 */}
        {showError && (
          <div className="bg-red-50 border-l-4 border-red-400 p-3 m-4">
            <div className="flex justify-between items-center">
              <p className="text-sm text-red-700">{showError}</p>
              <button
                onClick={() => setShowError(null)}
                className="text-red-400 hover:text-red-600"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>
        )}

        <DialogHeader className="px-6 pt-4 pb-3 bg-gradient-to-r from-slate-50 to-gray-50 border-b border-gray-100 flex-shrink-0">
          <div className="flex justify-between items-center">
            <div>
              <DialogTitle className="text-xl font-bold text-gray-900 mb-1">
                新しいレビューポイント定義を作成
              </DialogTitle>
              <p className="text-sm text-gray-500">
                AIレビューシステム用の新しいRPDを定義します
                {sessionId && (
                  <span className="ml-2 text-xs text-gray-400">
                    セッション: {sessionId.slice(-8)}
                  </span>
                )}
              </p>
            </div>
            {isSessionActive && (
              <div className="flex items-center text-xs text-green-600">
                <div className="w-2 h-2 bg-green-500 rounded-full mr-1"></div>
                アクティブ
              </div>
            )}
          </div>
        </DialogHeader>

        <div className="flex h-[calc(85vh-5rem)] overflow-hidden">
          {/* 左側：編集エリア */}
          <div className="flex-1 border-r border-gray-200 bg-gradient-to-br from-white to-gray-50 p-4 overflow-y-auto">
            {/* ... 现有的Step 1和Step 2内容 ... */}

            {/* 在Step 2中更新ImageUploadArea的调用 */}
            {currentStep === 2 && (
              <div className="h-56 flex-shrink-0">
                <div className="bg-white rounded-lg shadow-sm border border-gray-100 h-full overflow-hidden">
                  <div className="h-full">
                    <ImageUploadArea
                      files={uploadedFiles}
                      onImageUpload={handleImageUpload}
                      onRemoveImage={removeFile}
                      onImageClick={(fileId) => {
                        // 处理图片点击逻辑
                      }}
                      selectedImageIndex={selectedImageIndex}
                      getImageDescription={getImageDescription}
                      onCopyDescription={async (description) => {
                        try {
                          await navigator.clipboard.writeText(description);
                          // 可以添加成功提示
                        } catch (err) {
                          console.error('Failed to copy description:', err);
                        }
                      }}
                      onRegenerateDescription={handleRegenerateDescription}
                      isSessionActive={isSessionActive}
                    />
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* 右側：プレビューエリア */}
          <div className="flex-1 bg-gradient-to-br from-slate-50 to-gray-100 p-4 overflow-y-auto">
            {/* ... 现有的预览内容 ... */}

            {/* 在预览区域添加文件状态展示 */}
            {uploadedFiles.length > 0 && (
              <div className="mb-4">
                <h5 className="text-sm font-semibold text-gray-700 mb-2">
                  アップロード済み画像 ({uploadedFiles.length})
                </h5>
                <div className="space-y-2">
                  {uploadedFiles.map((file, index) => (
                    <div
                      key={file.id}
                      className="flex items-center justify-between bg-white rounded-lg p-2 border border-gray-200"
                    >
                      <div className="flex items-center space-x-2">
                        <img
                          src={file.preview}
                          alt={`Image ${index + 1}`}
                          className="w-8 h-8 rounded object-cover"
                        />
                        <span className="text-sm text-gray-600">
                          画像 {index + 1}
                        </span>
                      </div>
                      <div className="flex items-center space-x-2">
                        {file.status === 'uploading' && (
                          <span className="text-xs text-blue-600">アップロード中...</span>
                        )}
                        {file.status === 'generating' && (
                          <span className="text-xs text-yellow-600">生成中...</span>
                        )}
                        {file.status === 'completed' && (
                          <span className="text-xs text-green-600">完了</span>
                        )}
                        {file.status === 'error' && (
                          <span className="text-xs text-red-600">エラー</span>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* 提交按钮 - 添加会话检查 */}
            {currentStep === 2 && (
              <div className="pt-3 border-t border-gray-200 flex-shrink-0 mt-4">
                <div className="flex justify-end">
                  <Button
                    onClick={() => void form.handleSubmit(handleSubmit)()}
                    disabled={!detailContent.trim() || !isSessionActive || isProcessing}
                    className="h-10 px-6 bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 disabled:from-gray-300 disabled:to-gray-400 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 disabled:hover:scale-100"
                  >
                    {isProcessing ? '処理中...' : 'RPDを作成'}
                  </Button>
                </div>
              </div>
            )}
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}

// 更新后的ImageUploadArea组件接口
interface ImageUploadAreaProps {
  files: UploadFileInfo[]; // 使用新的文件信息类型
  onImageUpload: (files: FileList | null) => Promise<void>;
  onRemoveImage: (fileId: string) => void; // 改为fileId
  onImageClick: (fileId: string) => void; // 改为fileId
  selectedImageIndex: number | null;
  getImageDescription: (fileId: string) => string; // 改为fileId
  onCopyDescription: (description: string) => Promise<void>;
  onRegenerateDescription: (fileId: string) => Promise<void>; // 改为fileId
  isSessionActive: boolean; // 新增会话状态
}
```

## 2. 主要改进点

### ✅ 会话管理集成

- 自动生成唯一会话ID
- 会话过期检测和提示
- 智能清理机制

### ✅ 临时存储支持

- 上传到临时S3路径
- 自动TTL清理
- 文件提升机制

### ✅ 用户体验优化

- 实时状态指示器
- 错误处理和重试
- 处理进度展示

### ✅ 资源管理

- 自动清理blob URL
- 会话过期处理
- 组件卸载清理

## 3. 错误处理策略

```typescript
// 错误处理的最佳实践
const handleError = useCallback((error: Error, context: string) => {
  console.error(`${context}:`, error);

  // 根据错误类型设置不同的提示
  if (error.message.includes('session')) {
    setShowError('会话已过期，请刷新页面重新开始');
  } else if (error.message.includes('upload')) {
    setShowError('图片上传失败，请检查网络连接后重试');
  } else if (error.message.includes('description')) {
    setShowError('AI描述生成失败，请稍后重试');
  } else {
    setShowError('操作失败，请稍后重试');
  }
}, []);
```

## 4. 性能优化建议

### 🚀 并发控制

- 限制同时上传的文件数
- 合理设置超时时间
- 避免重复请求

### 🚀 内存管理

- 及时清理blob URL
- 控制同时处理的文件数量
- 合理设置会话超时

### 🚀 用户体验

- 实时进度反馈
- 智能错误提示
- 离线状态处理

这样的集成实现了：

1. ✅ **智能资源管理** - 避免资源浪费
2. ✅ **良好用户体验** - 实时状态反馈
3. ✅ **健壮错误处理** - 各种异常情况处理
4. ✅ **自动清理机制** - 无需手动管理临时文件

用户现在可以安心地上传、删除、重新上传图片，系统会自动处理所有的临时存储和清理工作！
