# ä¸´æ—¶å­˜å‚¨é›†æˆç¤ºä¾‹

## æ¦‚è¿°

æœ¬æ–‡æ¡£å±•ç¤ºå¦‚ä½•åœ¨ `RPDCreateModalNew` ç»„ä»¶ä¸­é›†æˆä¸´æ—¶å­˜å‚¨åŠŸèƒ½ï¼Œå®ç°å›¾ç‰‡çš„ä¸´æ—¶ä¸Šä¼ ã€AIæè¿°ç”Ÿæˆå’Œæ™ºèƒ½æ¸…ç†ã€‚

## 1. ç»„ä»¶é›†æˆç¤ºä¾‹

```typescript
// RPDCreateModalNew.tsx çš„æ›´æ–°ç‰ˆæœ¬

import React, { useCallback, useEffect, useState } from 'react';
import { useImageUpload } from '@/hooks/useImageUpload';
import { useRPDSession } from '@/hooks/useRPDSession';
import { assetsService } from '@/api/assetsService';
import type { GenerateImageDescriptionResponse } from '@/types/assets';

interface RPDCreateModalNewProps {
  isOpen: boolean;
  onClose: () => void;
  projectId: string;
}

export default function RPDCreateModalNew({ isOpen, onClose, projectId }: RPDCreateModalNewProps) {
  // ... ç°æœ‰çŠ¶æ€
  const [currentStep, setCurrentStep] = useState<1 | 2>(1);
  const [selectedKey, setSelectedKey] = useState<PredefinedRPDKey | null>(null);
  const [title, setTitle] = useState<string>('');
  const [detailContent, setDetailContent] = useState<string>('');
  const [tags, setTags] = useState<string[]>([]);
  const [showError, setShowError] = useState<string | null>(null);

  // ä¼šè¯ç®¡ç†
  const {
    sessionId,
    cleanupSession,
    promoteTempImages,
    isSessionActive,
    refreshSession,
  } = useRPDSession({
    autoCleanup: true,
    sessionTimeout: 2 * 60 * 60 * 1000, // 2å°æ—¶
  });

  // å›¾ç‰‡ä¸Šä¼ ç®¡ç†
  const {
    uploadedFiles,
    uploadingCount,
    generatingCount,
    isProcessing,
    uploadFiles,
    regenerateDescription,
    removeFile,
    clearFiles,
    getFileDescription,
  } = useImageUpload({
    rpdType: selectedKey || 'general_ng_review',
    context: detailContent,
    autoGenerateDescription: true,
    maxConcurrentUploads: 2,
    sessionId, // ä¼ é€’ä¼šè¯ID
    useTempStorage: true, // å¯ç”¨ä¸´æ—¶å­˜å‚¨
  });

  // åˆ·æ–°ä¼šè¯æ´»è·ƒçŠ¶æ€
  useEffect(() => {
    if (isOpen && isSessionActive) {
      refreshSession();
    }
  }, [isOpen, isSessionActive, refreshSession, detailContent]);

  // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
  const handleImageUpload = useCallback(async (files: FileList | null) => {
    if (!files || !isSessionActive) return;

    try {
      setShowError(null);
      await uploadFiles(files);
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥';
      setShowError(errorMessage);
      console.error('Failed to upload images:', error);
    }
  }, [uploadFiles, isSessionActive]);

  // é‡æ–°ç”Ÿæˆæè¿°
  const handleRegenerateDescription = useCallback(async (fileId: string) => {
    if (!isSessionActive) return;

    try {
      await regenerateDescription(fileId, detailContent);
    } catch (error) {
      console.error('Failed to regenerate description:', error);
      // å¯ä»¥æ˜¾ç¤ºé”™è¯¯æç¤º
    }
  }, [regenerateDescription, detailContent, isSessionActive]);

  // è·å–å›¾ç‰‡æè¿°ï¼ˆæ”¯æŒä¸´æ—¶å­˜å‚¨çŠ¶æ€ï¼‰
  const getImageDescription = useCallback((fileId: string): string => {
    const description = getFileDescription(fileId);
    if (description) {
      return description.detailed_description;
    }

    // æ ¹æ®çŠ¶æ€è¿”å›ä¸åŒçš„æç¤º
    const file = uploadedFiles.find(f => f.id === fileId);
    if (!file) return 'æ–‡ä»¶æœªæ‰¾åˆ°';

    switch (file.status) {
      case 'uploading':
        return 'æ­£åœ¨ä¸Šä¼ åˆ°ä¸´æ—¶å­˜å‚¨...';
      case 'generating':
        return 'æ­£åœ¨ç”ŸæˆAIæè¿°...';
      case 'error':
        return file.error || 'å¤„ç†å¤±è´¥';
      default:
        return 'ç­‰å¾…å¤„ç†...';
    }
  }, [getFileDescription, uploadedFiles]);

  // å¤„ç†æ¨¡æ€æ¡†å…³é—­
  const handleClose = useCallback(async () => {
    try {
      // æ¸…ç†æ‰€æœ‰çŠ¶æ€
      form.reset();
      setSelectedKey(null);
      setTitle('');
      setDetailContent('');
      setTags([]);
      setShowError(null);
      setCurrentStep(1);

      // æ¸…ç†ä¸Šä¼ æ–‡ä»¶çš„blob URL
      clearFiles();

      // æ¸…ç†ä¸´æ—¶ä¼šè¯æ–‡ä»¶
      await cleanupSession();

      onClose();
    } catch (error) {
      console.error('Failed to cleanup session on close:', error);
      // å³ä½¿æ¸…ç†å¤±è´¥ä¹Ÿè¦å…³é—­æ¨¡æ€æ¡†
      onClose();
    }
  }, [form, clearFiles, cleanupSession, onClose]);

  // å¤„ç†RPDåˆ›å»ºæäº¤
  const handleSubmit = useCallback(async (data: FormData) => {
    if (!isSessionActive) {
      setShowError('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°å¼€å§‹');
      return;
    }

    try {
      setShowError(null);

      // å‡†å¤‡RPDæ•°æ®ï¼ˆåŒ…å«ä¸´æ—¶å›¾ç‰‡URLï¼‰
      const rpdData = {
        ...data,
        projectId,
        title,
        tags,
        uploadedImages: uploadedFiles
          .filter(f => f.status === 'completed' && f.s3Url)
          .map(f => ({
            url: f.s3Url!,
            description: f.description?.detailed_description || '',
            keywords: f.description?.suggested_keywords || [],
          })),
        detailContent,
      };

      // åˆ›å»ºRPD
      console.log('Creating RPD with data:', rpdData);
      // await createRPD(rpdData); // å®é™…çš„RPDåˆ›å»ºAPIè°ƒç”¨

      // æˆåŠŸåˆ›å»ºåï¼Œå°†ä¸´æ—¶æ–‡ä»¶æå‡ä¸ºæ­£å¼æ–‡ä»¶
      try {
        await promoteTempImages(projectId);
        console.log('Successfully promoted temporary images to project');
      } catch (promotionError) {
        console.error('Failed to promote temporary images:', promotionError);
        // è¿™é‡Œå¯ä»¥é€‰æ‹©æ˜¯å¦è¦å›æ»šRPDåˆ›å»ºï¼Œæˆ–è€…åªæ˜¯è®°å½•é”™è¯¯
      }

      // å…³é—­æ¨¡æ€æ¡†ï¼ˆä¸æ‰§è¡Œæ¸…ç†ï¼Œå› ä¸ºæ–‡ä»¶å·²æå‡ï¼‰
      form.reset();
      setSelectedKey(null);
      setTitle('');
      setDetailContent('');
      setTags([]);
      setCurrentStep(1);
      clearFiles();
      onClose();

    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'RPDåˆ›å»ºå¤±è´¥';
      setShowError(errorMessage);
      console.error('Failed to create RPD:', error);
    }
  }, [
    isSessionActive,
    projectId,
    title,
    tags,
    uploadedFiles,
    detailContent,
    promoteTempImages,
    form,
    clearFiles,
    onClose,
  ]);

  // ç»„ä»¶å¸è½½æ—¶ç¡®ä¿æ¸…ç†
  useEffect(() => {
    return () => {
      if (!isOpen) {
        // å»¶è¿Ÿæ¸…ç†ï¼Œç¡®ä¿å…¶ä»–æ“ä½œå®Œæˆ
        setTimeout(() => {
          cleanupSession();
        }, 1000);
      }
    };
  }, [isOpen, cleanupSession]);

  return (
    <Dialog open={isOpen} onOpenChange={(open) => !open && handleClose()}>
      <DialogContent className="sm:max-w-6xl max-h-[85vh] p-0 overflow-hidden border-0 shadow-2xl">
        {/* ä¼šè¯çŠ¶æ€æŒ‡ç¤ºå™¨ */}
        {!isSessionActive && (
          <div className="bg-red-50 border-l-4 border-red-400 p-4 m-4">
            <div className="flex">
              <div className="flex-shrink-0">
                <svg className="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                </svg>
              </div>
              <div className="ml-3">
                <p className="text-sm text-red-700">
                  ä¼šè¯å·²è¿‡æœŸã€‚è¯·åˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹ã€‚
                </p>
              </div>
            </div>
          </div>
        )}

        {/* å¤„ç†çŠ¶æ€æŒ‡ç¤ºå™¨ */}
        {isProcessing && (
          <div className="bg-blue-50 border-l-4 border-blue-400 p-3 m-4">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
              </div>
              <div className="ml-3">
                <p className="text-sm text-blue-700">
                  {uploadingCount > 0 && `æ­£åœ¨ä¸Šä¼  ${uploadingCount} ä¸ªæ–‡ä»¶åˆ°ä¸´æ—¶å­˜å‚¨...`}
                  {generatingCount > 0 && `æ­£åœ¨ç”Ÿæˆ ${generatingCount} ä¸ªAIæè¿°...`}
                </p>
              </div>
            </div>
          </div>
        )}

        {/* é”™è¯¯æç¤º */}
        {showError && (
          <div className="bg-red-50 border-l-4 border-red-400 p-3 m-4">
            <div className="flex justify-between items-center">
              <p className="text-sm text-red-700">{showError}</p>
              <button
                onClick={() => setShowError(null)}
                className="text-red-400 hover:text-red-600"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>
        )}

        <DialogHeader className="px-6 pt-4 pb-3 bg-gradient-to-r from-slate-50 to-gray-50 border-b border-gray-100 flex-shrink-0">
          <div className="flex justify-between items-center">
            <div>
              <DialogTitle className="text-xl font-bold text-gray-900 mb-1">
                æ–°ã—ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆå®šç¾©ã‚’ä½œæˆ
              </DialogTitle>
              <p className="text-sm text-gray-500">
                AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ç”¨ã®æ–°ã—ã„RPDã‚’å®šç¾©ã—ã¾ã™
                {sessionId && (
                  <span className="ml-2 text-xs text-gray-400">
                    ã‚»ãƒƒã‚·ãƒ§ãƒ³: {sessionId.slice(-8)}
                  </span>
                )}
              </p>
            </div>
            {isSessionActive && (
              <div className="flex items-center text-xs text-green-600">
                <div className="w-2 h-2 bg-green-500 rounded-full mr-1"></div>
                ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
              </div>
            )}
          </div>
        </DialogHeader>

        <div className="flex h-[calc(85vh-5rem)] overflow-hidden">
          {/* å·¦å´ï¼šç·¨é›†ã‚¨ãƒªã‚¢ */}
          <div className="flex-1 border-r border-gray-200 bg-gradient-to-br from-white to-gray-50 p-4 overflow-y-auto">
            {/* ... ç°æœ‰çš„Step 1å’ŒStep 2å†…å®¹ ... */}

            {/* åœ¨Step 2ä¸­æ›´æ–°ImageUploadAreaçš„è°ƒç”¨ */}
            {currentStep === 2 && (
              <div className="h-56 flex-shrink-0">
                <div className="bg-white rounded-lg shadow-sm border border-gray-100 h-full overflow-hidden">
                  <div className="h-full">
                    <ImageUploadArea
                      files={uploadedFiles}
                      onImageUpload={handleImageUpload}
                      onRemoveImage={removeFile}
                      onImageClick={(fileId) => {
                        // å¤„ç†å›¾ç‰‡ç‚¹å‡»é€»è¾‘
                      }}
                      selectedImageIndex={selectedImageIndex}
                      getImageDescription={getImageDescription}
                      onCopyDescription={async (description) => {
                        try {
                          await navigator.clipboard.writeText(description);
                          // å¯ä»¥æ·»åŠ æˆåŠŸæç¤º
                        } catch (err) {
                          console.error('Failed to copy description:', err);
                        }
                      }}
                      onRegenerateDescription={handleRegenerateDescription}
                      isSessionActive={isSessionActive}
                    />
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* å³å´ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */}
          <div className="flex-1 bg-gradient-to-br from-slate-50 to-gray-100 p-4 overflow-y-auto">
            {/* ... ç°æœ‰çš„é¢„è§ˆå†…å®¹ ... */}

            {/* åœ¨é¢„è§ˆåŒºåŸŸæ·»åŠ æ–‡ä»¶çŠ¶æ€å±•ç¤º */}
            {uploadedFiles.length > 0 && (
              <div className="mb-4">
                <h5 className="text-sm font-semibold text-gray-700 mb-2">
                  ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒ ({uploadedFiles.length})
                </h5>
                <div className="space-y-2">
                  {uploadedFiles.map((file, index) => (
                    <div
                      key={file.id}
                      className="flex items-center justify-between bg-white rounded-lg p-2 border border-gray-200"
                    >
                      <div className="flex items-center space-x-2">
                        <img
                          src={file.preview}
                          alt={`Image ${index + 1}`}
                          className="w-8 h-8 rounded object-cover"
                        />
                        <span className="text-sm text-gray-600">
                          ç”»åƒ {index + 1}
                        </span>
                      </div>
                      <div className="flex items-center space-x-2">
                        {file.status === 'uploading' && (
                          <span className="text-xs text-blue-600">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</span>
                        )}
                        {file.status === 'generating' && (
                          <span className="text-xs text-yellow-600">ç”Ÿæˆä¸­...</span>
                        )}
                        {file.status === 'completed' && (
                          <span className="text-xs text-green-600">å®Œäº†</span>
                        )}
                        {file.status === 'error' && (
                          <span className="text-xs text-red-600">ã‚¨ãƒ©ãƒ¼</span>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* æäº¤æŒ‰é’® - æ·»åŠ ä¼šè¯æ£€æŸ¥ */}
            {currentStep === 2 && (
              <div className="pt-3 border-t border-gray-200 flex-shrink-0 mt-4">
                <div className="flex justify-end">
                  <Button
                    onClick={() => void form.handleSubmit(handleSubmit)()}
                    disabled={!detailContent.trim() || !isSessionActive || isProcessing}
                    className="h-10 px-6 bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 disabled:from-gray-300 disabled:to-gray-400 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 disabled:hover:scale-100"
                  >
                    {isProcessing ? 'å‡¦ç†ä¸­...' : 'RPDã‚’ä½œæˆ'}
                  </Button>
                </div>
              </div>
            )}
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}

// æ›´æ–°åçš„ImageUploadAreaç»„ä»¶æ¥å£
interface ImageUploadAreaProps {
  files: UploadFileInfo[]; // ä½¿ç”¨æ–°çš„æ–‡ä»¶ä¿¡æ¯ç±»å‹
  onImageUpload: (files: FileList | null) => Promise<void>;
  onRemoveImage: (fileId: string) => void; // æ”¹ä¸ºfileId
  onImageClick: (fileId: string) => void; // æ”¹ä¸ºfileId
  selectedImageIndex: number | null;
  getImageDescription: (fileId: string) => string; // æ”¹ä¸ºfileId
  onCopyDescription: (description: string) => Promise<void>;
  onRegenerateDescription: (fileId: string) => Promise<void>; // æ”¹ä¸ºfileId
  isSessionActive: boolean; // æ–°å¢ä¼šè¯çŠ¶æ€
}
```

## 2. ä¸»è¦æ”¹è¿›ç‚¹

### âœ… ä¼šè¯ç®¡ç†é›†æˆ

- è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€ä¼šè¯ID
- ä¼šè¯è¿‡æœŸæ£€æµ‹å’Œæç¤º
- æ™ºèƒ½æ¸…ç†æœºåˆ¶

### âœ… ä¸´æ—¶å­˜å‚¨æ”¯æŒ

- ä¸Šä¼ åˆ°ä¸´æ—¶S3è·¯å¾„
- è‡ªåŠ¨TTLæ¸…ç†
- æ–‡ä»¶æå‡æœºåˆ¶

### âœ… ç”¨æˆ·ä½“éªŒä¼˜åŒ–

- å®æ—¶çŠ¶æ€æŒ‡ç¤ºå™¨
- é”™è¯¯å¤„ç†å’Œé‡è¯•
- å¤„ç†è¿›åº¦å±•ç¤º

### âœ… èµ„æºç®¡ç†

- è‡ªåŠ¨æ¸…ç†blob URL
- ä¼šè¯è¿‡æœŸå¤„ç†
- ç»„ä»¶å¸è½½æ¸…ç†

## 3. é”™è¯¯å¤„ç†ç­–ç•¥

```typescript
// é”™è¯¯å¤„ç†çš„æœ€ä½³å®è·µ
const handleError = useCallback((error: Error, context: string) => {
  console.error(`${context}:`, error);

  // æ ¹æ®é”™è¯¯ç±»å‹è®¾ç½®ä¸åŒçš„æç¤º
  if (error.message.includes('session')) {
    setShowError('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹');
  } else if (error.message.includes('upload')) {
    setShowError('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
  } else if (error.message.includes('description')) {
    setShowError('AIæè¿°ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  } else {
    setShowError('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  }
}, []);
```

## 4. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### ğŸš€ å¹¶å‘æ§åˆ¶

- é™åˆ¶åŒæ—¶ä¸Šä¼ çš„æ–‡ä»¶æ•°
- åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´
- é¿å…é‡å¤è¯·æ±‚

### ğŸš€ å†…å­˜ç®¡ç†

- åŠæ—¶æ¸…ç†blob URL
- æ§åˆ¶åŒæ—¶å¤„ç†çš„æ–‡ä»¶æ•°é‡
- åˆç†è®¾ç½®ä¼šè¯è¶…æ—¶

### ğŸš€ ç”¨æˆ·ä½“éªŒ

- å®æ—¶è¿›åº¦åé¦ˆ
- æ™ºèƒ½é”™è¯¯æç¤º
- ç¦»çº¿çŠ¶æ€å¤„ç†

è¿™æ ·çš„é›†æˆå®ç°äº†ï¼š

1. âœ… **æ™ºèƒ½èµ„æºç®¡ç†** - é¿å…èµ„æºæµªè´¹
2. âœ… **è‰¯å¥½ç”¨æˆ·ä½“éªŒ** - å®æ—¶çŠ¶æ€åé¦ˆ
3. âœ… **å¥å£®é”™è¯¯å¤„ç†** - å„ç§å¼‚å¸¸æƒ…å†µå¤„ç†
4. âœ… **è‡ªåŠ¨æ¸…ç†æœºåˆ¶** - æ— éœ€æ‰‹åŠ¨ç®¡ç†ä¸´æ—¶æ–‡ä»¶

ç”¨æˆ·ç°åœ¨å¯ä»¥å®‰å¿ƒåœ°ä¸Šä¼ ã€åˆ é™¤ã€é‡æ–°ä¸Šä¼ å›¾ç‰‡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†æ‰€æœ‰çš„ä¸´æ—¶å­˜å‚¨å’Œæ¸…ç†å·¥ä½œï¼
